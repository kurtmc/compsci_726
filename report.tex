\documentclass[9pt,technote]{IEEEtran} 
\usepackage[numbers]{natbib}

\title{TorScript: A Proposed Framework For Standardised Implementation of Countermeasures Against Attacks on Tor} 
\date{today}
\author{Jenna Finlayson~~Kurt McAlpine}

\begin{document} 
\maketitle

\begin{abstract} Tor provides anonymity by routing communications within layers
of encryption. A vulnerability in the Tor network is the indirect rate reduction
attack. This attack can reduce anonymity by monitoring client connections and
spoofing traffic on Tor exit relay. By spoofing messages to an exit relay at a
rate slower than the client was previously receiving messages, a rate reduction
can be observed. This indicates that the client is likely to be communicating
with that specific server. We propose a method to counteract this attack by
extending Tor to mask the rate of messages being received. \end{abstract}

\section{Introduction} 
The majority of surveillance that occurs today is the surveillance of data and communications on the internet \cite{diffie2008brave}. Since the 2013 leaks from Edward Snowden we now know the scale of and government power behind mass internet surveillance. It is therefore important for internet users to have a way to protect themselves from certain types of surveillance that can expose their identities and online behaviour. One solution to this is to use an anonymity network such as Tor. Tor allows anonymous communication by using layers of encryption and routing network traffic between multiple volunteer operated onion routers \cite{tor}. This aids in the concealment of the
user's physical location, identity, and usage from potential surveyors. To keep
safe from government surveillance it is important to employ countermeasures for the security vulnerabilities in Tor as they are identified.\\

New security attacks on Tor are being discovered frequently and are often published with specific ways to counteract them. Most of these proposed countermeasures come at a cost to network performance and performance of Tor and require implementations in the Tor source code directly. This requires knowledge of the Tor architecture and code base in order to implement the countermeasure, and then needs to be integrated and deployed in Tor itself. This process takes time and is not a simple process due to Tor's complexity so it therefore leaves Tor open to the identified vulnerabilities for potentially very long periods of time. \\

We propose TorScript, a framework for standardised implementation of countermeasures against attacks on Tor. [overview of stuff about how our framework works].

% Here's all the citations we have to use. 
\cite{hayesguard}\cite{gilad2012spying}\cite{sun2015raptor}\cite{biryukov2012torscan}\cite{jansen2014sniper}\cite{tor}

\section{Related Work} In order to show the types of attacks that can be used to reduce the anonymity of the Tor network, we summarise papers that identify some of these types of attacks and the authors' proposed countermeasures for them. We then identify flaws in the implementation and potential deployment problems of these countermeasures. We could not find any literature about any existing standardised frameworks like the one we propose and have therefore focused on identifying different attack types that our framework can work with.\\

\subsection{Rate Reduction Attack}
To identify communicating peers in Tor, an attacker can eavesdrop on two peers they think are communicating. They can then use traffic analysis to identify patterns in the communication behaviour of both and identify similarities between them to conclude that they are indeed communicating with one another. This type of attack is difficult as it requires access to both peers to eavesdrop on the traffic behaviour. \citeauthor{gilad2012spying} have detailed a type of attack on Tor that requires only eavesdropping on the client, while carrying out an active attack on the exit relay of a Tor circuit in order to identify communicating peers.

The attack is a variant of the Idle Scan attack, however instead of trying to find open ports on a server, the authors try to determine the identity of communicating peers. To carry out the attack, three consecutive spoofed messages with invalid TCP sequence numbers are sent to the exit relay as if it came from the destination communicating peer that has a direct TCP connection to the exit relay. This causes three duplicate ACK messages to be sent from the exit relay to the destination peer which is considered to be a congestion event in TCP. As a result of the congestion event occurring, the congestion window on the destination peer is shrunk and the `sending rate' decreases. This decrease in sending rate can be seen on the origin peer as the rate of communication with the destination has been reduced. If this event is observed on the origin peer as a result of the active attack on the exit node that is communicating with the destination peer, it can be concluded that the origin and destination peer are in fact communicating.

The countermeasures that \citeauthor{gilad2012spying} have identified for this type of attack on Tor include discarding packets that do not have valid sequence numbers and also increasing the size of the congestion window so that it takes longer to cause a congestion event. Increasing the size of the congestion window on the destination peer would not be a viable robust solution as it would require all servers that could possibly be being communicated with to implement this change. It would also change the behaviour of real congestion events which could cause a loss in network performance. Similarly, by discarding out of sequence TCP packets, congestion control of actual congestion events would be modified and this would also be likely to affect network performance. 

An ideal countermeasure for this type of attack would be to modify Tor itself so that modification of destination peers is not necessary. We propose that Tor implement the ability to control the rate of sending packets so that consecutive spoofed messages cannot cause congestion events as easily, and in the case that they do, the reduction in rate is not so observable on the origin peer.

\subsection{Guard Selection Attack}
Prior to 2015, Tor's guard selection strategy was to have each user be allocated a small set of guard nodes from which three of them would be used for extended periods. In 2015 and later, Tor's default guard selection strategy now involves users selecting one guard node from a set of nodes that are all highly available and have a high bandwidth, and using this single node for up to nine months. Both of these selection strategies have security vulnerabilities that allow attackers to identify communicating peers as identified by \citeauthor{hayesguard}.

The attacks identified that involve these guard selection strategies include:
\begin{itemize}
\item \textbf{Direct Observation:} With one corrupt guard node and a small selection of corrupt exit relays, at least one circuit can be identified for a particular user.
\item \textbf{Guard Fingerprinting:} Identifying the set of guards used by a user, which is likely to be unique to that user and hence act as a fingerprint.
\item \textbf{Statistical Disclosure Attacks:} In the case that a given guard set is only used by a small number of users, it is possible to discover long term identifiers through analysing their patterns of actions.
\end{itemize}

\citeauthor{hayesguard} have proposed a new method for guard selection involving the use of ``Guard Sets''. Guard sets are sets of relays that are used by many users and each set provides a certain amount of bandwidth. This approach counteracts the three attack types outlined above. Having no rotation of guard nodes for users means that fewer clients are exposed to malicious nodes which counteracts Direct Observation attacks. Because each guard set is used by many users, Guard Fingerprinting cannot be used to uniquely identify users. Finally, Statistical Disclosure Attacks also cannot be used on guard sets due to there being large and equal sets of users for each guard set.

\citeauthor{hayesguard} have designed an algorithm to automatically assign guards and users to guard sets. This means that there is little left to counteracting these attacks other than writing the implementation into the Tor application. This, as explained earlier, is not a trivial problem due to the complexity of the Tor code base. Once it is implemented, it would take time to be approved and accepted into the code base as well then getting deployed.

\subsection{Tor Scanning Attacks}
\citeauthor{biryukov2012torscan} propose four different scanning attacks on Tor to reduce anonymity. The first attack exposes existing TLS connections a particular Tor relay has with other relays by scanning the Tor relay in question. As Tor uses canonical connections, i.e. reuses already open connections when another connection is requested, it is possible to identify existing connections between relays. When sending a \texttt{RELAY EXTEND} cell, the destination fingerprint and IP must be specified. In the case that a connection already exists, the IP is ignored and the existing connection is used. A \texttt{RELAY EXTENDED} cell is then returned back to the origin relay to confirm. If the two relays do not have an existing connection, a new one is attempted to be created using the provided IP address. If the IP address specifies an unreachable port, the connection is refused and a \texttt{DESTROY} cell is returned. Using this information, attackers can send \texttt{RELAY EXTEND} cells to specific Tor relays, giving the fingerprint of the Tor relay in question and an unreachable port. Based on the type of cell that is returned, it can be determined whether the two relays had an existing connection open or not.

\subsection{Sniper Attack}
The sniper attack outlined by \citeauthor{jansen2014sniper} describes a denial
of service attack that can be targeted to any Tor node. The attack is relatively cheap where the attacker only needs 92 KiB/s upstream to start consuming memory at 2187 KiB/s. The way the attack works is by starting a large download over the Tor network, then stop reading from the entry relay and then maliciously sending \texttt{SENDME} requests to the exit relay, this forces the entry relay to queue up cells to send to the client. The Linux OOM killer will kill the tor process when the machine runs out of memory, disabling that node.

The solution to the attack is to selectively kill tor circuits when the machine
is about a critical memory usage amount.

\subsection{Routing Attack}
A suite of attacks described by \citeauthor{sun2015raptor} includes attacks that
can be performed by Autonomous System adversaries. Here we describe the high
level details of the attacks described in the paper.
\subsubsection{Asymmetric Traffic Analysis Attack}
This attack extends the well known ``end-to-end timing analysis attack'' whereby
observing communications between the client and the Tor entry relay as well as
observing traffic between the Tor exit relay and the destination the attacker
can correlate the timing data to detect if the client is communicating with the
destination. In the conventional attack the adversary needs to monitor both the
forward traffic from the client to the entry relay, and the exit relay to the
destination relay as well as the backward traffic from the entry relay to the
client, and the destination to the exit relay. However the forward and backward
traffic routes are often not the same. \citeauthor{sun2015raptor} describes the
asymmetric traffic analysis attack as only needing to observe traffic in one of
the directions to correlate the data and determine if the client is
communicating with the destination. This attack increases the ability of
AS-level adversaries to deanonymise Tor users by increasing the amount of ASes
that can correlate data.
\subsubsection{BGP Churn}
The internet paths between clients and Tor relays change over time due to
physical changes in the network topology caused by system failures, system
recoveries, the introduction of new routers and links, and changes to AS-level
routing policies. These changes can increase the ability of ASes to observe Tor
traffic. For example in [Figure 2 from the paper] you can see that only AS5 can
compromise anonymity, but when the link between AS5 and AS4 is destroyed, AS5
and AS3 can compromise anonymity.
\subsubsection{BGP Hijack}
The previous attacks where passive, but it is also possible for AS's to launch
active attacks. It is possible for an AS to deviate from the default routing
behaviour by manipulating the inter-domain routing by communicating fake BGP
control messages. An AS can hijack and IP prefix by announcing the prefix as its
own. This attack will cause some small percentage of the internet traffic that
was destined to the prefix to be collected by the adversary. This allows ASes to
increase their chance of observing traffic between clients and entry relays, and
exit relays and destinations. However the disadvantage of this attack is that
the traffic is silently dropped without telling the source that the data has not
reached the recipient resulting in the connection being dropped.
\subsubsection{BGP Interception}
The authors describe an attack called BGP Interception which allows an AS to be
an intermediate AS between the guard and the client as well as between the exit
relay and the destination. The advantage of BGP Interception is that the
connection is not dropped allowing the connection to stay alive, unlike BGP
Hijack. They show that 90\% of Tor relays are vulnerable to interception
attacks. This attack increase the ability of an AS to perform the Asymmetric
Traffic Analysis Attack. 
\subsubsection{Countermeasures}
\begin{itemize}
\item \textbf{AS-Aware Path Selection:} Selecting the Tor relays that will be in
	the path allows us to minimise the chances for AS-level traffic
	analysis. The Tor network can monitor the path dynamics between guards
	and clients as well as between exit relays and destinations. This data
	can be distributed to all Tor clients and then Tor clients can use this
	information to make relay selections. Tor clients would select relays
	such that the same AS in not in first segment of the IP address as well
	as in the last segment of the IP address.
\item \textbf{Advertising /24 Tor prefixes:} More than 90\% of Tor relays use a
	prefix length shorter than /24. This makes them vulnerable to the AS BGP
	hijack or interception attacks since AS's usually filter router
	advertisements with a prefix longer than /24.
\item \textbf{Favouring Closer Guard Relays:} Even if a Tor relay advertises a
	/24 prefix, it is still possible for an adversary to launch a specific
	prefix hijack or interception attack. If this is the case the impact is
	limited to localised attackers AS since the route is not globally
	propagated. Tor client should choose their guard relays with a shorter
	AS-level path between them. This reduces the risk of a specific prefix
	attack as well as the risk of asymmetric traffic analysis and BGP churn.
\end{itemize}


\section{Extending Tor with a Scripting Language}
Currently the Tor project is a significantly large application written in C,
with around 216000 lines of code. The size of the project and the lack of an
extensible API provides a high barrier of entry to making modifications to the
project. We want to make it easier for developers and researchers to extend tor
especially to implement countermeasures mentioned in academic articles. If it
was easier to modify tor, we could reduce the time it takes for security issues
to be resolved once they are discovered.

We propose exposing the internals of Tor with a scripting language such as
Python. This will allow developers and researchers to write small amounts of code to extend Tor to fix security issues. The choice of Python is to reduce the complexity of making a modification to Tor, C is an unforgiving language and requires a high degree of experience to write robust and secure code.

Several areas of the Tor internals will need to be exposed by the Python plugin
architecture. To implement a plugin that circumvents the ``Sniper Attack''
circuits and the ability to kill them need to be exposed by the language.

\bibliographystyle{IEEEtranN}
\bibliography{references}

\end{document}
